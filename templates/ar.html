{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>AR Jardin</title>
    <!-- A-Frame itself -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <!-- Pure three.js code that the A-Frame components use for location-based AR -->
    <script src= "{% static 'js/arjs.js' %}" ></script>
    <!-- AR.js A-Frame components -->
    <script type='text/javascript'
        src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
    <style>
        /* Estilos para superponer el botón en la esquina superior izquierda */
        #button-container {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1;
        }

        /* Estilos para el recuadro blanco del resultado */
        #result-container {
            cursor: pointer;
            position: absolute;
            background-color: white;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            bottom: 10px;
            left: 10px;
            z-index: 1;
        }

        #buttonEncuesta-container {
            position: absolute;
            top: 0;
            left: 0;
            margin: 10px; /* Agrega margen para separar el botón del borde */
            z-index: 5;
        }

        /* Estilos para el recuadro blanco del resultado */
        #encuesta-container a {
            text-decoration: none;
            cursor: pointer;
            background-color: white;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            z-index: 1;
        }

        /* Estilos para el texto del resultado */
        #result-text {
            font-weight: bold;
        }

        /* Estilos para el cuadro de texto de la planta */
        #plant-container {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 2;
            /* Mayor z-index para que esté por encima del botón */
        }

        /* Estilos para el texto de la planta */
        #plant-text {
            font-weight: bold;
        }
    </style>
    <script>

    </script>

</head>

<body>
    <div id="teachable-machine-container">

        <div id="result-container" class="button" onclick="togglePredicting()">
            <p>Resultado: <span id="result-text">Ninguna</span></p>
        </div>

        <div id="buttonEncuesta-container">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="usuario_id" value="{{ usuario_id }}">
                <input type="hidden" name="visita_id" value="{{ visita_id }}">
                <button id="encuesta-container" type="submit" name="action" value="EncuestaView">Encuesta {{ usuario_id }}</button>
            </form>
        </div>

        <div id="webcam-container"></div>
        <div id="label-container"></div>
        <a-scene arjs>
            <a-camera position="0 0 0" rotation-reader></a-camera>
            <a-light type="point" intensity="1" position="0 3 0"></a-light>
            <a-entity id="llama-container" position="0 0 -1.5">
                <a-animation attribute="position" dur="1000" to="0 0 -2" begin="move-llama"></a-animation>
                <a-entity id="llama1" gltf-model="Llama.glb" visible="false" scale="0.27 0.1125 0.27"
                    rotation="0 -45 0"></a-entity>
                <a-image id="cuadro-image1" src="Cuadro.png" visible="false" scale="0.84 0.25 0.49"
                    position="0 0.2 0"></a-image>
                <a-text id="cuadro-text1" value="" scale="0.3 0.15 0.3" color="black" text-align="center"
                    position="-0.32 0.22 0.1"></a-text>
                <a-text id="cuadro-text2" value="" scale="0.3 0.15 0.3" color="black" text-align="center"
                    position="-0.1 0.17 0.1" font-weight="bold"></a-text>

                <a-image id="cuadro1" src="cuadro.png" visible="false" scale="0.84 0.25 0.49" position="0.75 0.1 1.2"
                    rotation="0 -75 0"></a-image>
                <a-text id="text1" value="" scale="0.15 0.1 0.1" color="black" text-align="center"
                    position="0.52 0.09 1" rotation="0 -75 0"></a-text>
                <a-text id="text3" value="" scale="0.15 0.1 0.1" color="black" text-align="center"
                    position="0.54 0.06 1.1" rotation="0 -75 0"></a-text>

                <a-image id="cuadro2" src="cuadro.png" visible="false" scale="0.84 0.25 0.49" position="-0.75 0.1 1.2"
                    rotation="0 75 0"></a-image>
                <a-text id="text2" value="" scale="0.16 0.1 0.1" color="black" text-align="center"
                    position="-0.83 0.1 1.55" rotation="0 75 0"></a-text>
            </a-entity>



        </a-scene>

        <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
        <script
            src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
        <script type="text/javascript">

            // Elementos de la escena
            const scene = document.querySelector('a-scene');
            const sphere = document.querySelector('a-sphere');

            let model, maxPredictions, webcam;
            var predictedClass = "Ninguna", result = "Ninguna";
            let isPredicting = false;


            async function init() {
                
                //const URL = "https://teachablemachine.withgoogle.com/models/q3x-NPhmI/";
                const URL = "https://teachablemachine.withgoogle.com/models/oHdXApnC4/";

                const modelURL = URL + "model.json";
                const metadataURL = URL + "metadata.json";
                model = await tmImage.load(modelURL, metadataURL);
                maxPredictions = model.getTotalClasses();

                const flip = false;
                webcam = new tmImage.Webcam(500, 400, flip);
                await webcam.setup({ facingMode: "environment" });
                await webcam.play();

                //document.getElementById("webcam-container").appendChild(webcam.canvas);
                window.requestAnimationFrame(loop);

            }

            function togglePredicting() {
                isPredicting = true;
                let timer = setTimeout(() => {
                    isPredicting = false;
                    console.log("Es una: ", predictedClass);
                    result = predictedClass;
                    show3DModels(result);
                    predictedClass = "Ninguna";
                }, 1000);
            }

            // Bucle para actualizar las predicciones
            async function loop() {
                webcam.update();
                if (isPredicting) {
                    await predict();
                }
                window.requestAnimationFrame(loop);
            }

            // Función para realizar predicciones
            async function predict() {
                const prediction = await model.predict(webcam.canvas);
                for (let i = 0; i < maxPredictions; i++) {

                    if (prediction[i].probability >= 0.95) {
                        const classPrediction = `Clase: ${prediction[i].className} - Probabilidad: ${prediction[i].probability.toFixed(2)}`;
                        predictedClass = prediction[i].className;
                    } else {
                    }
                }
            }

            // Evento de carga de la página
            window.addEventListener('load', function () {
                init();
            });

            // Función para mostrar modelos 3D con AR.js y A-Frame
            function show3DModels(resulta) {

                // Encuentra la cámara en la escena
                const camera = document.querySelector('a-camera');

                //const llamaEntity = document.querySelector('a-entity[gltf-model="Llama.glb"]');
                const resultText = document.getElementById("result-text");
                const llamaContainer = document.querySelector('#llama-container');
                const llamaEntity = document.querySelector('#llama1');
                const cuadroImage = document.querySelector('#cuadro-image1');
                const cuadroText1 = document.querySelector('#cuadro-text1');
                const cuadroText2 = document.querySelector('#cuadro-text2');
                const cuadro1 = document.querySelector('#cuadro1');
                const cuadro2 = document.querySelector('#cuadro2');
                const Text1 = document.querySelector('#text1');
                const Text2 = document.querySelector('#text2');
                const Text3 = document.querySelector('#text3');

                // Define colores para cada clase
                const colors = {
                    "Hortensia": "blue",
                    "Hortensia1": "Asiatico",
                    "Hortensia2": "Color depende del sol",
                    "Hortensia3": "Constante",
                    "Cartucho": "green",
                    "Cartucho1": "Cajamarquino",
                    "Cartucho2": "Brota en tiempo de lluvia",
                    "Cartucho3": "1 mes",
                    "Lirio": "yellow",
                    "Lirio1": "Griego",
                    "Lirio2": "Habita en zonas montanosas",
                    "Lirio3": "Constante",
                    "Anturia": "orange",
                    "Anturia1": "Selva",
                    "Anturia2": "Propiedades descontaminantes",
                    "Anturia3": "4  meses",
                    "Veronica": "purple",
                    "Veronica1": "Oceania",
                    "Veronica2": "80 cm de altura",
                    "Veronica3": "Constante"
                    // Agrega más colores y clases según tus necesidades
                };

                // Cambia el color de la esfera según la clase reconocida
                if (resulta in colors) {
                    llamaContainer.emit('move-llama');
                    llamaEntity.setAttribute('visible', 'true');
                    cuadroImage.setAttribute('visible', 'true');
                    cuadro1.setAttribute('visible', 'true');
                    cuadro2.setAttribute('visible', 'true');
                    cuadroText1.setAttribute('text', 'value', `Esta planta se llama:`);
                    cuadroText1.setAttribute('look-at', '[camera]');
                    cuadroText2.setAttribute('text', 'value', `${resulta}`);
                    cuadroText2.setAttribute('look-at', '[camera]');
                    Text1.setAttribute('text', 'value', `Origen: ${colors[resulta + '1']}`);
                    Text1.setAttribute('look-at', '[camera]');
                    Text3.setAttribute('text', 'value', `Tiempo de vida: ${colors[resulta + '3']}`);
                    Text3.setAttribute('look-at', '[camera]');
                    Text2.setAttribute('text', 'value', `Curiosidad: ${colors[resulta + '2']}`);
                    Text2.setAttribute('look-at', '[camera]');
                } else {
                    llamaEntity.setAttribute('visible', 'false');
                    cuadroImage.setAttribute('visible', 'false');
                    cuadro1.setAttribute('visible', 'false');
                    cuadro2.setAttribute('visible', 'false');
                    cuadroText1.setAttribute('text', 'value', '');
                    cuadroText2.setAttribute('text', 'value', '');
                    Text1.setAttribute('text', 'value', ``);
                    Text2.setAttribute('text', 'value', ``);
                    Text3.setAttribute('text', 'value', ``);
                }

                resultText.textContent = resulta;

            }

        </script>
    </div>
</body>

</html>